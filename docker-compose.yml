# Docker Compose para desarrollo y producci贸n en Droplet
# Facilita el deploy y gesti贸n de la aplicaci贸n

version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Estas variables se pasan durante el build
        # Para producci贸n, usa .env.production
        - DATABASE_URL=${DATABASE_URL}
        - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
        - NEXT_PUBLIC_CLERK_URL=${NEXT_PUBLIC_CLERK_URL}

        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
    ports:
      - "3000:3000"
    environment:
      # Todas las variables de entorno necesarias
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      CLERK_SIGNING_SECRET: ${CLERK_SIGNING_SECRET}
      NEXT_PUBLIC_CLERK_URL: ${NEXT_PUBLIC_CLERK_URL}

      MUX_TOKEN_ID: ${MUX_TOKEN_ID}
      MUX_TOKEN_SECRET: ${MUX_TOKEN_SECRET}
      MUX_WEBHOOK_SECRET: ${MUX_WEBHOOK_SECRET}
      UPLOADTHING_TOKEN: ${UPLOADTHING_TOKEN}
      UPLOADTHING_SECRET: ${UPLOADTHING_SECRET}
      UPSTASH_REDIS_REST_URL: ${UPSTASH_REDIS_REST_URL}
      UPSTASH_REDIS_REST_TOKEN: ${UPSTASH_REDIS_REST_TOKEN}
      SENTRY_ORG: ${SENTRY_ORG}
      SENTRY_PROJECT: ${SENTRY_PROJECT}
      SENTRY_AUTH_TOKEN: ${SENTRY_AUTH_TOKEN}
      NEXT_PUBLIC_SENTRY_DSN: ${NEXT_PUBLIC_SENTRY_DSN}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Para usar:
# 1. Crea un archivo .env.production con todas las variables
# 2. Ejecuta: docker-compose up -d
# 3. Para ver logs: docker-compose logs -f
# 4. Para detener: docker-compose down

